<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>PacMan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
</head>
<body>
<h2 style="text-align:center; font-family: Arial; color: white;">PACMAN</h2>

<div id="box">
  <div id="punteggio"><p>Punti: 0</p></div>
  <div id="info"><p>Usa le frecce per muoverti!</p></div>
</div>

<div id="controlli">
  Difficolt√†:
  <select id="difficolta">
    <option value="300">Facile</option>
    <option value="200">Media</option>
    <option value="100">Difficile</option>
    <option value="50">Estrema</option>
  </select>
  <button onclick="avviaGioco()">Avvia</button>
  <button onclick="resetCronologia()">Reset Cronologia</button>
</div>

<div id="mappa"></div>

<div id="cronologia">
  <h3>Cronologia</h3>
  <ul id="listaCronologia"></ul>
</div>

<script>
  const righe = 15;
  const colonne = 15;
  let pacman = { x: 1, y: 1 };
  let fantasma = { x: 13, y: 13 };
  let direzione = { x: 0, y: 0 };
  let punteggio = 0;
  let intervalGhost;
  let pareti = [];

  function generaPareti() {
    pareti = [];
    for (let y = 0; y < righe; y++) {
      for (let x = 0; x < colonne; x++) {
        if (x === 0 || x === colonne - 1 || y === 0 || y === righe - 1 || (x % 4 === 0 && y % 4 === 0)) {
          pareti.push([x, y]);
        }
      }
    }
  }

  function creaMappa() {
    $("#mappa").empty();
    for (let y = 0; y < righe; y++) {
      let riga = $("<div class='riga'></div>");
      for (let x = 0; x < colonne; x++) {
        let cella = $("<div></div>");
        cella.attr("x", x).attr("y", y);

        if (pareti.some(p => p[0] === x && p[1] === y)) {
          cella.attr("elemento", "parete").addClass("parete");
        } else {
          cella.attr("elemento", "pallino").addClass("pallino");
        }

        riga.append(cella);
      }
      $("#mappa").append(riga);
    }
  }

  function aggiornaMappa() {
    $("div[elemento='pacman']").removeClass("pacman").attr("elemento", "vuoto");
    $("div[elemento='ghost']").removeClass("fantasma").attr("elemento", "vuoto");

    const pacDiv = $(`div[x=${pacman.x}][y=${pacman.y}]`);
    if (pacDiv.hasClass("pallino")) {
      pacDiv.removeClass("pallino");
      punteggio += 10;
      $("#punteggio p").text("Punti: " + punteggio);
    }
    pacDiv.addClass("pacman").attr("elemento", "pacman");

    const ghostDiv = $(`div[x=${fantasma.x}][y=${fantasma.y}]`);
    ghostDiv.addClass("fantasma").attr("elemento", "ghost");

    if (pacman.x === fantasma.x && pacman.y === fantasma.y) {
      clearInterval(intervalGhost);
      salvaPunteggio(punteggio);
      alert("Sei stato preso! Punti: " + punteggio);
      avviaGioco();
    }

    if ($(".pallino").length === 0) {
      clearInterval(intervalGhost);
      salvaPunteggio(punteggio);
      alert("Hai vinto! Punteggio finale: " + punteggio);
      avviaGioco();
    }
  }

  function avviaGioco() {
    pacman = { x: 1, y: 1 };
    fantasma = { x: colonne - 2, y: righe - 2 };
    direzione = { x: 0, y: 0 };
    punteggio = 0;
    $("#punteggio p").text("Punti: 0");
    generaPareti();
    creaMappa();
    aggiornaMappa();
    clearInterval(intervalGhost);
    let vel = parseInt($("#difficolta").val());
    intervalGhost = setInterval(muoviFantasma, vel);
    aggiornaCronologia();
  }

  function muoviPacman() {
    const next = { x: pacman.x + direzione.x, y: pacman.y + direzione.y };
    const target = $(`div[x=${next.x}][y=${next.y}]`);
    if (target.length && !target.hasClass("parete")) {
      pacman = next;
      aggiornaMappa();
    }
  }

  function muoviFantasma() {
    let dx = pacman.x - fantasma.x;
    let dy = pacman.y - fantasma.y;
    let mosse = [];

    if (dx !== 0) mosse.push({ x: Math.sign(dx), y: 0 });
    if (dy !== 0) mosse.push({ x: 0, y: Math.sign(dy) });

    if (mosse.length === 0 || Math.random() < 0.3) {
      mosse = [
        { x: 1, y: 0 },
        { x: -1, y: 0 },
        { x: 0, y: 1 },
        { x: 0, y: -1 }
      ];
    }

    for (let m of mosse) {
      let nx = fantasma.x + m.x;
      let ny = fantasma.y + m.y;
      let t = $(`div[x=${nx}][y=${ny}]`);
      if (t.length && !t.hasClass("parete")) {
        fantasma = { x: nx, y: ny };
        break;
      }
    }

    aggiornaMappa();
  }

  function salvaPunteggio(punti) {
    let cronologia = JSON.parse(localStorage.getItem("cronologia")) || [];

    let id = cronologia.length > 0 ? Math.max(...cronologia.map(p => p.id || 0)) + 1 : 1;

    cronologia.push({ id: id, punteggio: punti });

    localStorage.setItem("cronologia", JSON.stringify(cronologia));
    aggiornaCronologia();
  }

  function aggiornaCronologia() {
    let cronologia = JSON.parse(localStorage.getItem("cronologia")) || [];

    let valide = cronologia.filter(p => p && typeof p.id === "number" && typeof p.punteggio === "number");

    valide.sort((a, b) => b.punteggio - a.punteggio);

    $("#listaCronologia").empty();
    for (let item of valide) {
      $("#listaCronologia").append(`<li>Partita ${item.id}: ${item.punteggio} punti</li>`);
    }
  }


  function resetCronologia() {
    localStorage.removeItem("cronologia");
    aggiornaCronologia();
  }

  $(document).keydown(function (e) {
    switch (e.key) {
      case "ArrowUp": direzione = { x: 0, y: -1 }; break;
      case "ArrowDown": direzione = { x: 0, y: 1 }; break;
      case "ArrowLeft": direzione = { x: -1, y: 0 }; break;
      case "ArrowRight": direzione = { x: 1, y: 0 }; break;
    }
    muoviPacman();
  });

  $(document).ready(function () {
    aggiornaCronologia();
  });
</script>
</body>
</html>
